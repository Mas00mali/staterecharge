<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="topbar card">
    <div class="brand">Admin Panel</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h3>Pending Membership Requests</h3>
      <div id="pendingList" class="small">Loading...</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Users</h3>
      <div id="usersList">Loading...</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Transactions</h3>
      <div id="txnList">Loading...</div>
    </div>

  </div>

  <script src="firebase.js"></script>
  <script>
    // Admin guard: must be logged in and have role 'ADMIN'
    (async function guard(){
      const user = await window._NM.currentUserPromise();
      if(!user) return location.href='index.html';
      const doc = await window._NM.getUserDoc(user.uid);
      if(!doc || doc.role !== 'ADMIN'){ alert('Access denied. Make sure user role=ADMIN in Firestore.'); return location.href='dashboard.html'; }
      loadPending();
      loadUsers();
      loadTxns();
    })();

    async function loadPending(){
      const wrap = document.getElementById('pendingList');
      wrap.innerHTML = 'Loading...';
      try{
        const reqs = await window._NM.getPendingMembershipRequests(500);
        if(!reqs.length){ wrap.innerHTML = '<div class="small">No pending requests.</div>'; return; }
        wrap.innerHTML = '';
        reqs.forEach(r=>{
          const el = document.createElement('div');
          el.className = 'card';
          el.style.marginBottom='8px';
          el.innerHTML = `
            <div style="display:flex;gap:12px;align-items:center">
              <div style="flex:1">
                <div><strong>${r.name}</strong> <span class="small">(${r.userUid})</span></div>
                <div class="small">Plan: ${r.planKey} • Amount: ₹${r.planPrice}</div>
                <div class="small">UTR: ${r.utr}</div>
                <div class="small">Submitted: ${r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : ''}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button class="btn btn-primary" onclick="approve('${r.id}')">Approve</button>
                <button class="btn btn-ghost" onclick="reject('${r.id}')">Reject</button>
              </div>
            </div>
          `;
          wrap.appendChild(el);
        });
      }catch(e){ wrap.innerText = 'Error: ' + e.message; }
    }

    async function approve(id){
      if(!confirm('Approve and distribute commission?')) return;
      const admin = firebase.auth().currentUser;
      try{
        await window._NM.adminApproveRequest(id, admin ? admin.uid : 'ADMIN');
        alert('Approved and commissions distributed.');
        loadPending(); loadUsers(); loadTxns();
      }catch(e){ alert('Error: ' + e.message); }
    }
    async function reject(id){
      const reason = prompt('Reject reason (optional)');
      const admin = firebase.auth().currentUser;
      try{
        await window._NM.adminRejectRequest(id, admin ? admin.uid : 'ADMIN', reason || '');
        alert('Rejected.');
        loadPending();
      }catch(e){ alert('Error: ' + e.message); }
    }

    async function loadUsers(){
      const wrap = document.getElementById('usersList');
      wrap.innerHTML = 'Loading...';
      try{
        const users = await window._NM.getAllUsers();
        if(!users.length){ wrap.innerHTML='<div class="small">No users</div>'; return; }
        const table = document.createElement('table'); table.className='table';
        table.innerHTML = `<thead><tr><th>Name</th><th>Email</th><th>Wallet</th><th>Plan</th><th>Action</th></tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        users.forEach(u=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.name || ''}</td><td>${u.email || ''}</td><td>₹ ${u.walletBalance || 0}</td><td>${u.plan || ''}</td>
            <td>
              <button class="btn btn-primary" onclick="promptCredit('${u.id}','${u.name || ''}')">Credit</button>
              <button class="btn btn-ghost" onclick="promptDebit('${u.id}','${u.name || ''}')">Debit</button>
            </td>`;
          tbody.appendChild(tr);
        });
        wrap.innerHTML = ''; wrap.appendChild(table);
      }catch(e){ wrap.innerText = 'Error: ' + e.message; }
    }

    function promptCredit(uid, name){
      const amt = prompt(`Enter credit amount for ${name}:`);
      if(!amt) return;
      window._NM.creditWallet(uid, Number(amt), `Admin credit by ${firebase.auth().currentUser.uid}`).then(()=> {
        alert('Credited');
        loadUsers(); loadTxns();
      }).catch(e=> alert('Error: '+ e.message));
    }
    function promptDebit(uid, name){
      const amt = prompt(`Enter debit amount for ${name}:`);
      if(!amt) return;
      window._NM.debitWallet(uid, Number(amt), `Admin debit by ${firebase.auth().currentUser.uid}`).then(()=> {
        alert('Debited');
        loadUsers(); loadTxns();
      }).catch(e=> alert('Error: '+ e.message));
    }

    async function loadTxns(){
      const wrap = document.getElementById('txnList');
      wrap.innerHTML = 'Loading...';
      try{
        const txs = await window._NM.getAllTransactions(200);
        if(!txs.length){ wrap.innerHTML = '<div class="small">No transactions</div>'; return; }
        wrap.innerHTML = txs.map(t => `<div class="small">${t.createdAt && t.createdAt.toDate ? t.createdAt.toDate().toLocaleString() : ''} • ${t.userId} • ${t.type} • ₹${t.amount} • ${t.note || ''}</div>`).join('');
      }catch(e){ wrap.innerText = 'Error: ' + e.message; }
    }

    function logout(){ window._NM.logout(); }
  </script>
</body>
</html>
