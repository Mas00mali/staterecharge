<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="style.css">
  <script src="firebase.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f9fafb; padding:20px; }
    h1 { text-align:center; }
    table { width:100%; border-collapse: collapse; margin:20px 0; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#3b82f6; color:white; }
    button { padding:5px 10px; margin:2px; border:none; border-radius:5px; cursor:pointer; }
    .credit { background:green; color:white; }
    .debit { background:red; color:white; }
    .approve { background:#22c55e; color:white; }
    .reject { background:#ef4444; color:white; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>
  <button onclick="logout()">Logout</button>

  <h2>All Users</h2>
  <table id="userTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Balance</th>
        <th>Plan</th>
        <th>Sponsor</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Pending UTR Requests</h2>
  <table id="utrTable">
    <thead>
      <tr>
        <th>User</th>
        <th>Plan</th>
        <th>UTR</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Logout
    function logout(){
      auth.signOut().then(()=> location.href='login.html');
    }

    // Load Users
    function loadUsers(){
      db.collection("users").onSnapshot(snapshot=>{
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML="";
        snapshot.forEach(doc=>{
          const u=doc.data();
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>₹${u.balance||0}</td>
            <td>${u.plan}</td>
            <td>${u.sponsor||"-"}</td>
            <td>
              <button class="credit" onclick="updateBalance('${doc.id}',100)">+100</button>
              <button class="debit" onclick="updateBalance('${doc.id}',-100)">-100</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    async function updateBalance(uid, amt){
      const ref=db.collection("users").doc(uid);
      const snap=await ref.get();
      if(!snap.exists) return;
      const bal=snap.data().balance||0;
      await ref.update({ balance: bal+amt });
      alert("Balance Updated ✅");
    }

    // Load UTR Requests
    function loadUTRs(){
      db.collection("utr_requests").where("status","==","pending")
      .onSnapshot(snapshot=>{
        const tbody = document.querySelector("#utrTable tbody");
        tbody.innerHTML="";
        snapshot.forEach(doc=>{
          const r=doc.data();
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${r.userId||"?"}</td>
            <td>${r.plan}</td>
            <td>${r.utrNumber}</td>
            <td>${r.status}</td>
            <td>
              <button class="approve" onclick="approveUTR('${doc.id}')">Approve</button>
              <button class="reject" onclick="rejectUTR('${doc.id}')">Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    // Approve UTR
    async function approveUTR(id){
      const ref=db.collection("utr_requests").doc(id);
      const snap=await ref.get();
      if(!snap.exists) return;
      const req=snap.data();
      
      // Update user plan
      const userRef=db.collection("users").doc(req.userId);
      await userRef.update({ plan: req.plan });

      // Mark request approved
      await ref.update({ status:"approved", approvedAt:new Date() });

      // Commission distribution (5 levels)
      let sponsorId=req.sponsorId;
      const commission = {
        silver:[100,50,25,10,5],
        gold:[500,250,125,75,50],
        diamond:[1000,500,250,150,100]
      };
      let level=0;
      while(sponsorId && level<5){
        const sRef=db.collection("users").doc(sponsorId);
        const sSnap=await sRef.get();
        if(!sSnap.exists) break;
        const sData=sSnap.data();
        const bal=sData.balance||0;
        const amt=commission[req.plan][level];
        await sRef.update({ balance: bal+amt });
        sponsorId=sData.sponsor;
        level++;
      }
      alert("UTR Approved + Commission Distributed ✅");
    }

    async function rejectUTR(id){
      await db.collection("utr_requests").doc(id).update({ status:"rejected" });
      alert("UTR Rejected ❌");
    }

    // Check admin login
    auth.onAuthStateChanged(user=>{
      if(!user){
        location.href="admin-login.html";
      }else{
        loadUsers();
        loadUTRs();
      }
    });
  </script>
</body>
</html>
