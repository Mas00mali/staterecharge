<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Dashboard - ICAN</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="topbar card">
    <div class="brand">ICAN Network</div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button class="btn btn-ghost" onclick="openProfile()">Profile</button>
      <button class="btn btn-ghost" onclick="location.href='admin.html'">Admin</button>
      <button class="btn btn-ghost" onclick="doLogout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <!-- Coins layer -->
    <div id="coinLayer" style="position:fixed;inset:0;pointer-events:none;z-index:5"></div>

    <!-- Plans -->
    <div style="text-align:center;margin:18px 0">
      <h2 class="h2">Choose Your Plan</h2>
    </div>

    <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap">
      <div class="plan-card silver">
        <h3>Silver</h3>
        <div style="font-weight:800;font-size:20px">₹599</div>
        <div class="small">Commission: 100/50/25/10/5</div>
        <button class="btn btn-primary" onclick="openBuy('silver',599,'https://i.postimg.cc/R07NbjBZ/Screenshot-20250902-232628.jpg')">Buy Silver</button>
      </div>

      <div class="plan-card gold">
        <h3 style="color: #222">Gold</h3>
        <div style="font-weight:800;font-size:20px;color:#222">₹2599</div>
        <div class="small" style="color:#f3d06a">Commission (approx): 430/215/110/45/25</div>
        <button class="btn btn-primary" onclick="openBuy('gold',2599,'https://i.postimg.cc/R07NbjBZ/Screenshot-20250902-232628.jpg')">Buy Gold</button>
      </div>

      <div class="plan-card diamond">
        <h3 style="color:#022">Diamond</h3>
        <div style="font-weight:800;font-size:20px;color:#022">₹5599</div>
        <div class="small" style="color:#bff">Commission (approx): 935/470/235/95/45</div>
        <button class="btn btn-primary" onclick="openBuy('diamond',5599,'https://i.postimg.cc/R07NbjBZ/Screenshot-20250902-232628.jpg')">Buy Diamond</button>
      </div>
    </div>

    <!-- Wallet & Team summary -->
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:18px">
      <div class="card" style="flex:1;min-width:260px">
        <div class="small">Wallet Balance</div>
        <div id="wallet" class="wallet-big">₹ 0</div>
      </div>

      <div class="card" style="flex:1;min-width:260px">
        <div class="small">Referral Code</div>
        <div id="refcode" style="font-family:monospace;font-weight:800"></div>
      </div>
    </div>

  </div>

  <!-- BUY Modal -->
  <div id="buyModal" class="modal-backdrop" style="display:none;z-index:60">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800" id="modalTitle">Buy Plan</div>
        <button class="btn btn-ghost" onclick="closeBuy()">Close</button>
      </div>
      <div style="text-align:center;margin-top:10px">
        <img id="modalQR" src="" alt="QR" style="width:220px;border-radius:8px;border:2px solid gold">
      </div>
      <div style="margin-top:12px">
        <input id="buy_name" class="input" placeholder="Enter your name (as in bank)">
        <div style="height:8px"></div>
        <input id="buy_utr" class="input" placeholder="Enter UTR number">
        <div style="height:8px"></div>
        <button id="buySubmit" class="btn btn-primary" onclick="submitBuy()">Submit UTR</button>
        <div id="buyMsg" class="small" style="margin-top:10px;display:none"></div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal-backdrop" style="display:none;z-index:70">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Edit Profile</div>
        <button class="btn btn-ghost" onclick="closeProfile()">Close</button>
      </div>
      <div style="margin-top:12px">
        <input id="profile_name" class="input" placeholder="Full name">
        <div style="height:8px"></div>
        <input id="profile_email" class="input" placeholder="Email">
        <div style="height:8px"></div>
        <input id="profile_photo" class="input" placeholder="Photo URL">
        <div style="height:8px"></div>
        <button class="btn btn-primary" onclick="saveProfile()">Save</button>
        <div id="profileMsg" class="small" style="margin-top:8px;display:none"></div>
      </div>
    </div>
  </div>

  <script src="firebase.js"></script>
  <script>
    // protect page and init
    (async function init(){
      try { protectPage(); } catch(e){}
      const user = await window._NM.currentUserPromise();
      if(!user) return location.href='index.html';
      const doc = await window._NM.getUserDoc(user.uid);
      document.getElementById('wallet').innerText = '₹ ' + (doc.walletBalance || 0);
      document.getElementById('refcode').innerText = doc.referralCode || user.uid.slice(0,6).toUpperCase();
      // coins spawn
      startCoins();
    })();

    // coin rain
    function startCoins(){
      const layer = document.getElementById('coinLayer');
      function spawnBatch(){
        for(let i=0;i<5;i++){
          const c = document.createElement('div');
          c.className='coin';
          const size = 10 + Math.random()*18;
          c.style.width = c.style.height = size + 'px';
          c.style.left = Math.random() * (window.innerWidth - 40) + 'px';
          c.style.animationDuration = (4 + Math.random()*3) + 's';
          layer.appendChild(c);
          setTimeout(()=> c.remove(), 9000);
        }
      }
      spawnBatch();
      setInterval(spawnBatch, 2000);
    }

    // buy modal logic
    let selectedPlan = null;
    let selectedPrice = 0;
    let selectedQR = '';

    function openBuy(planKey, price, qr){
      selectedPlan = planKey; selectedPrice = price; selectedQR = qr;
      document.getElementById('modalTitle').innerText = planKey.toUpperCase() + ' • ₹' + price;
      document.getElementById('modalQR').src = qr;
      document.getElementById('buyMsg').style.display = 'none';
      document.getElementById('buy_name').value = '';
      document.getElementById('buy_utr').value = '';
      document.getElementById('buyModal').style.display = 'flex';
    }
    function closeBuy(){ document.getElementById('buyModal').style.display = 'none'; }

    async function submitBuy(){
      const name = document.getElementById('buy_name').value.trim();
      const utr = document.getElementById('buy_utr').value.trim();
      if(!name||!utr) return alert('Enter name & UTR');
      const user = await window._NM.currentUserPromise();
      if(!user) return alert('Login first');
      // create membership request
      const id = await window._NM.createMembershipRequest(user.uid, selectedPlan, selectedPrice, name, utr, selectedQR);
      document.getElementById('buyMsg').style.display='block';
      document.getElementById('buyMsg').innerText = 'Request submitted. Waiting admin approval. RequestID: ' + id;
      // open whatsapp notify
      const adminPhone = '7318432028';
      const message = encodeURIComponent(`New membership request\nName:${name}\nPlan:${selectedPlan}\nPrice:${selectedPrice}\nUTR:${utr}\nUser:${user.uid}\nReq:${id}`);
      window.open(`https://wa.me/91${adminPhone}?text=${message}`, '_blank');
      setTimeout(()=> closeBuy(), 1200);
    }

    // profile modal
    async function openProfile(){
      const user = await window._NM.currentUserPromise();
      if(!user) return;
      const doc = await window._NM.getUserDoc(user.uid);
      document.getElementById('profile_name').value = doc.name || '';
      document.getElementById('profile_email').value = doc.email || '';
      document.getElementById('profile_photo').value = doc.photoURL || '';
      document.getElementById('profileModal').style.display = 'flex';
    }
    function closeProfile(){ document.getElementById('profileModal').style.display = 'none'; }
    async function saveProfile(){
      const user = await window._NM.currentUserPromise();
      if(!user) return alert('Login first');
      const name = document.getElementById('profile_name').value.trim();
      const email = document.getElementById('profile_email').value.trim();
      const photo = document.getElementById('profile_photo').value.trim();
      // update Firestore user doc (not auth email)
      await firebase.firestore().collection('users').doc(user.uid).update({ name, email, photoURL: photo });
      document.getElementById('profileMsg').style.display='block';
      document.getElementById('profileMsg').innerText = 'Profile saved.';
      setTimeout(()=> closeProfile(), 900);
    }

    async function doLogout(){ await window._NM.logout(); }
  </script>
</body>
</html>
